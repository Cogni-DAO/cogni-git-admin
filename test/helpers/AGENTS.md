# Test Helpers

Utility modules for testing webhook handling and application behavior.

## Components

### `fixture-replay.ts`
Replays captured webhook fixtures against running servers for deterministic testing.

#### Functionality
- Reads JSON fixture files containing webhook metadata
- Decodes base64-encoded body data to exact raw bytes
- Constructs HTTP requests matching original webhooks
- Sends requests to specified target URLs (HTTP only, not HTTPS)
- Returns response status codes for assertions
- Implements 10-second timeout for request completion
- Provides debug logging with `[replay]` prefix
- Automatically consumes response body to prevent connection hanging

#### API
```typescript
replayFixture(fixturePath: string, targetUrl: string): Promise<number>
```

**Parameters:**
- `fixturePath`: Path to JSON fixture file containing webhook metadata
- `targetUrl`: Full URL of target endpoint (e.g., `http://localhost:3000/api/v1/webhooks/onchain/cogni-signal`)

**Returns:** HTTP status code from the response (0 if no status code received)

#### Usage Example
```typescript
const statusCode = await replayFixture(
  'fixtures/alchemy/CogniSignal/example.json',
  'http://localhost:3000/api/v1/webhooks/onchain/cogni-signal'
);
expect(statusCode).toBe(200);
```

## Integration
Works with fixtures generated by `tools/dev/webhook-capture/` to enable record-and-replay testing of webhook handling logic.

## Current Usage
- **E2E Testing**: Used by `e2e/e2e-runner.ts` for MVP smoke testing against deployed applications
- **Fixture Source**: Replays fixtures from `fixtures/alchemy/CogniSignal/` directory
- **Location**: Moved to `e2e/helpers/fixture-replay.ts` as it's E2E-specific

## Limitations
- **HTTP Only**: Does not support HTTPS connections (uses Node's `http` module)
- **No Response Capture**: Consumes but does not return response body for analysis
- **Header Preservation**: Preserves original headers except `content-length` which is recalculated
- **No Signature Validation**: Preserves but does not validate HMAC signature headers