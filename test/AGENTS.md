# Test Infrastructure

Testing framework and utilities for the Cogni Git Admin application.

## Directory Structure
```
test/
├─ fixtures/              # Captured webhook payloads
│  ├─ alchemy/            # Alchemy blockchain webhook fixtures
│  │  └─ CogniSignal/     # CogniSignal event fixtures
│  ├─ github/             # GitHub webhook fixtures
│  └─ unknown/            # Unidentified webhook fixtures
├─ helpers/               # Test utility modules
│  └─ fixture-replay.ts   # Webhook fixture replay functionality
└─ index.test.ts          # Main test suite
```

## Test Helpers

### Fixture Replay (`helpers/fixture-replay.ts`)
Replays captured webhook fixtures against running servers:
- Reads fixture files containing raw webhook data
- Cleans proxy-injected headers that interfere with SSL/TLS negotiation
- Preserves essential headers (auth, content-type) while removing proxy artifacts
- Configures proper TLS settings for edge server compatibility
- Sends replayed webhooks to specified target URLs
- Returns HTTP status code for verification
- Includes 10-second timeout for requests
- Provides debug logging for troubleshooting

#### Fixture Format Expected
```typescript
{
  headers: Record<string, string | string[]>;
  body_raw_base64: string;  // Base64-encoded raw bytes
  method: string;            // HTTP method
  url: string;               // Original request path
}
```

## Testing Workflow
1. Capture real webhooks using `tools/dev/webhook-capture/`
2. Store fixtures in `fixtures/` directory organized by provider
3. Use `fixture-replay.ts` to replay webhooks in tests
4. Verify application behavior with deterministic inputs

## Integration with Systems

### Capture System
Test fixtures are generated by the webhook capture tool (`tools/dev/webhook-capture/`) and organized by provider type. Fixtures contain exact webhook metadata including headers and base64-encoded raw body.

### E2E Testing
The fixture replay system is used by E2E tests (`e2e/e2e-runner.ts`) to validate webhook processing against deployed applications. Successfully connects to DigitalOcean deployments with proper SSL/TLS handling. Provides smoke testing with HTTP 2xx response validation and optional GitHub API verification.

## Known Limitations
- Signature headers from original webhooks are preserved but not validated
- Response bodies are consumed but not captured for analysis
- GitHub App installation IDs are hardcoded per environment